

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Carla tutorial &mdash; DI-drive 0.3.4 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Auto policy running and visualization" href="auto_run.html" />
    <link rel="prev" title="Core Concepts and Processes" href="core_concepts.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> DI-drive
          

          
          </a>

          
            
            
              <div class="version">
                0.3.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../installation/index.html">Installation</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Tutorial</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="core_concepts.html">Core Concepts and Processes</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Carla tutorial</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#basic-concept-of-carla">Basic Concept of Carla</a></li>
<li class="toctree-l3"><a class="reference internal" href="#quickly-create-carla-server-via-docker">Quickly Create Carla server via Docker</a></li>
<li class="toctree-l3"><a class="reference internal" href="#carla-server-settings">Carla server settings</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="auto_run.html">Auto policy running and visualization</a></li>
<li class="toctree-l2"><a class="reference internal" href="il_tutorial.html">Simple Imitation Learning</a></li>
<li class="toctree-l2"><a class="reference internal" href="rl_tutorial.html">Simple Reinforcement Learning</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../features/index.html">Features</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../model_zoo/index.html">Model Zoo</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api_doc/index.html">API Doc</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../faq/index.html">FAQ</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">DI-drive</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Tutorial</a> &raquo;</li>
        
      <li>Carla tutorial</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/tutorial/carla_tutorial.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <section id="carla-tutorial">
<h1>Carla tutorial<a class="headerlink" href="#carla-tutorial" title="Permalink to this heading">¶</a></h1>
<div class="toctree-wrapper compound">
</div>
<p>Carla is currently the mainly used simulator in DI-drive. This page shows some bacis concepts and
a quick user guide to run Carla simulator, for quick hands-on use of Carla in DI-drive</p>
<section id="basic-concept-of-carla">
<h2>Basic Concept of Carla<a class="headerlink" href="#basic-concept-of-carla" title="Permalink to this heading">¶</a></h2>
<p>Carla simulator runs in a client-server architecture. The sever and clients run individually. The server
contains map, weather, actors and all physical simulation. The clients can control the actors by
sending commands and ticking world in Carla server by its Python API. The server and clients
communicate through TCP link, consisting of a host and port provided by server, which can be specified when
establishing the server.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./CarlaUE4.sh<span class="w"> </span>--carla-world-port<span class="o">=</span>N
</pre></div>
</div>
<p>Usually <cite>N</cite> is set as an even number, because the port <cite>N+1</cite> is simultanously occupied to connect the server. Carla
also uses a Traffic Manager port to control global behaviors of vehicles. It is specified at the
client side. TM client can not only be built by DI-drive via automatically finding free port in current system,
but also manually set by users.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">carla_env</span> <span class="o">=</span> <span class="n">SimpleCarlaEnv</span><span class="p">(</span><span class="n">env_cfg</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">tm_port</span><span class="p">)</span>
</pre></div>
</div>
<p>Carla simulation can run in <strong>sync</strong> mode or <strong>async</strong> mode. In <strong>asynchronous</strong> mode, the server runs
as fast as possible regardless of the client. In <strong>synchronous</strong> mode, the server and client runs in the
same fixed time step (common set as 0.1s), while the server will wait for client’s tick before updating
next step. For reasonable IL and RL trainning, DI-drive set Carla client and server to synchronous mode by default.</p>
<p>Carla allows multiple clients linking to one server. So make sure your Carla server only has one client
linked or only one client is sending command, in case of entangled or chaotic simulation.</p>
<p>When a client is destroyed, the actors and weather it create/change will NOT be released or reset.
So make sure to call the <code class="docutils literal notranslate"><span class="pre">clean_up</span></code> method in simulator to manually destroy all actors and reset weather
changed by the client.</p>
</section>
<section id="quickly-create-carla-server-via-docker">
<h2>Quickly Create Carla server via Docker<a class="headerlink" href="#quickly-create-carla-server-via-docker" title="Permalink to this heading">¶</a></h2>
<p>It is recommended to run Carla server in <a class="reference external" href="https://www.docker.com">docker</a> which makes the installation
much easier and can run multiple Carla servers. DI-drive follows guidance in Carla doc which uses
<a class="reference external" href="https://docs.docker.com/engine/install/ubuntu">docker CE</a> and
<a class="reference external" href="https://github.com/NVIDIA/nvidia-docker">nvidia docker2</a>.</p>
<p>Then, just pull the Carla image and run with port.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker<span class="w"> </span>pull<span class="w"> </span>carlasim/carla:0.9.10
<span class="c1"># by default</span>
docker<span class="w"> </span>run<span class="w"> </span>-p<span class="w"> </span><span class="m">2000</span>-2002:9000-9002<span class="w"> </span>--runtime<span class="o">=</span>nvidia<span class="w"> </span>--gpus<span class="w"> </span>&lt;gpu_id&gt;<span class="w"> </span>carlasim/carla:0.9.10
<span class="c1"># with parameters</span>
docker<span class="w"> </span>run<span class="w"> </span>-p<span class="w"> </span><span class="m">2000</span>-2002:9000-9002<span class="w"> </span>--runtime<span class="o">=</span>nvidia<span class="w"> </span>--gpus<span class="w"> </span>&lt;gpu_id&gt;<span class="w"> </span>carlasim/carla:0.9.10<span class="w"> </span>/bin/bash<span class="w"> </span>CarlaUE4.sh<span class="w"> </span>&lt;list<span class="w"> </span>of<span class="w"> </span>paremeters&gt;
</pre></div>
</div>
<p>We also provide an easily used multi-carla docker image that can start an amount of Carla servers.
You can pull the image from <a class="reference external" href="https://hub.docker.com">dockerhub</a> and start with your own settings.
For example, the following command will start a container with 8 Carla server whose ports are set
from 9000 to 9014</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>docker<span class="w"> </span>pull<span class="w"> </span>opendilab/multi-carla:0.9.10
docker<span class="w"> </span>run<span class="w"> </span>-p<span class="w"> </span><span class="m">9000</span>-9016:9000-9016<span class="w"> </span>--runtime<span class="o">=</span>nvidia<span class="w"> </span>opendilab/multi-carla:0.9.10<span class="w"> </span>/bin/bash<span class="w"> </span>run_carla.sh<span class="w"> </span>-n<span class="w"> </span><span class="m">8</span><span class="w"> </span>-p<span class="w"> </span><span class="m">9000</span>
</pre></div>
</div>
<p>Generally, the option <code class="docutils literal notranslate"><span class="pre">-n</span> <span class="pre">NUMS</span></code> sets the number of Carla server and the option <code class="docutils literal notranslate"><span class="pre">-p</span> <span class="pre">PORT</span></code> sets
the start port of servers. The other servers’ port are set to the following even number.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Please pay attention to the Carla port within and out of the container. The internal ones are set
by the parameters in carla scripts, the external ones are set when creating the container.</p>
</div>
</section>
<section id="carla-server-settings">
<h2>Carla server settings<a class="headerlink" href="#carla-server-settings" title="Permalink to this heading">¶</a></h2>
<p>We provide config setting to quickly set host and port for several Carla servers. The <code class="docutils literal notranslate"><span class="pre">server</span></code> key in config
file is used to set Carla servers. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">server</span><span class="o">=</span><span class="p">[</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">carla_host</span><span class="o">=</span><span class="s1">&#39;192.168.1.1&#39;</span><span class="p">,</span> <span class="n">carla_ports</span><span class="o">=</span><span class="p">[</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">5010</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">carla_host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">carla_ports</span><span class="o">=</span><span class="p">[</span><span class="mi">9000</span><span class="p">,</span> <span class="mi">9010</span><span class="p">,</span> <span class="mi">2</span><span class="p">]),</span>
    <span class="p">],</span>
    <span class="o">...</span>
<span class="p">)</span>
</pre></div>
</div>
<p>You can use Carla servers in several IP hosts, each is stored as an element in <code class="docutils literal notranslate"><span class="pre">server</span></code> list. Each IP has a
host and a list of ports. The interval between ports is 2, because Carla needs two ports to communicate. By
defalut the <cite>N+1</cite> port is occupied. The saving form of ports in config is similar to the Python <code class="docutils literal notranslate"><span class="pre">range</span></code> method.
<code class="code docutils literal notranslate"><span class="pre">carla_ports=[9000,</span> <span class="pre">9010,</span> <span class="pre">2]</span></code> means there are 5 Carla servers whose ports are ‘9000, 9002, 9004, 9006
, 9008’.</p>
</section>
</section>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="auto_run.html" class="btn btn-neutral float-right" title="Auto policy running and visualization" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="core_concepts.html" class="btn btn-neutral float-left" title="Core Concepts and Processes" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2021, OpenDILab

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>